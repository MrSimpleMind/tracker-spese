<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Tracker spese famiglia - Gestisci le spese di famiglia in modo semplice">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spese">
    <link rel="manifest" href="/tracker-spese/manifest.json">
    <link rel="apple-touch-icon" href="/tracker-spese/icon-192.png">
    <title>Tracker Spese Famiglia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e ReactDOM DEVONO essere caricati PRIMA -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js per i grafici -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif;
            overscroll-behavior: none;
        }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <!-- Fallback se non carica -->
    <noscript>
        <div style="text-align: center; padding: 50px;">
            <h1>‚ö†Ô∏è JavaScript richiesto</h1>
            <p>Abilita JavaScript nel tuo browser per usare l'app</p>
        </div>
    </noscript>

    <script type="text/babel" data-type="module">
        // Verifica che tutte le librerie siano caricate
        setTimeout(() => {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof firebase === 'undefined') {
                document.getElementById('root').innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: system-ui;">
                        <h1 style="color: #dc2626; font-size: 2rem;">‚ùå Errore di Caricamento</h1>
                        <p style="color: #6b7280; margin: 20px 0;">Le librerie non si sono caricate correttamente.</p>
                        <p style="color: #6b7280; margin: 10px 0;"><strong>Controlla:</strong></p>
                        <ul style="color: #6b7280; text-align: left; max-width: 400px; margin: 20px auto;">
                            <li>‚úì Connessione internet attiva</li>
                            <li>‚úì Browser aggiornato (Chrome/Safari consigliati)</li>
                            <li>‚úì Nessun blocco di contenuti/ad-blocker</li>
                        </ul>
                        <button onclick="location.reload()" style="background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 20px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
                return;
            }
        }, 5000);

        const { useState, useEffect } = React;

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAIDL3WgLSagcABDgXh3P0zlHq77lYTnpc",
            authDomain: "tracker-di-spese.firebaseapp.com",
            projectId: "tracker-di-spese",
            storageBucket: "tracker-di-spese.firebasestorage.app",
            messagingSenderId: "68753897947",
            appId: "1:68753897947:web:3699b0dde868c1457a4ffe"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Registra Service Worker per PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/tracker-spese/sw.js').catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            });
        }

        // Componente principale
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('spese');
            const [spese, setSpese] = useState([]);
            const [categorie, setCategorie] = useState([]);
            const [reminders, setReminders] = useState([]);
            const [showAddSpesa, setShowAddSpesa] = useState(false);
            const [showAddCategoria, setShowAddCategoria] = useState(false);
            const [showAddReminder, setShowAddReminder] = useState(false);
            const [showGrafico, setShowGrafico] = useState(false);
            const [editingSpesa, setEditingSpesa] = useState(null);
            const [editingCategoria, setEditingCategoria] = useState(null);
            const [editingReminder, setEditingReminder] = useState(null);
            const [filtroCategoria, setFiltroCategoria] = useState('tutte');
            const [reminderScaduti, setReminderScaduti] = useState(0);

            // Auth listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    setUser(user);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            // Listener Firestore - Spese
            useEffect(() => {
                if (!user) return;
                
                const unsubscribe = db.collection('spese')
                    .orderBy('data', 'desc')
                    .onSnapshot(snapshot => {
                        const speseData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setSpese(speseData);
                    });
                
                return unsubscribe;
            }, [user]);

            // Listener Firestore - Categorie
            useEffect(() => {
                if (!user) return;
                
                const unsubscribe = db.collection('categorie')
                    .orderBy('nome')
                    .onSnapshot(snapshot => {
                        const categorieData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setCategorie(categorieData);
                    });
                
                return unsubscribe;
            }, [user]);

            // Listener Firestore - Reminder
            useEffect(() => {
                if (!user) return;
                
                const unsubscribe = db.collection('reminders')
                    .orderBy('dataScadenza')
                    .onSnapshot(snapshot => {
                        const remindersData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setReminders(remindersData);
                        
                        const oggi = new Date().toISOString().split('T')[0];
                        const scaduti = remindersData.filter(r => 
                            !r.completato && r.dataScadenza < oggi
                        ).length;
                        setReminderScaduti(scaduti);
                        
                        if (scaduti > 0 && Notification.permission === 'granted') {
                            new Notification('Tracker Spese', {
                                body: `Hai ${scaduti} reminder scaduti!`,
                                icon: 'üí∞'
                            });
                        }
                    });
                
                return unsubscribe;
            }, [user]);

            useEffect(() => {
                if (user && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }, [user]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Caricamento...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginPage />;
            }

            return (
                <div className="min-h-screen pb-20">
                    <div className="bg-blue-600 text-white p-3 sticky top-0 z-10 shadow-lg">
                        <div className="flex justify-between items-center">
                            <span className="text-sm truncate flex-1 mr-2">{user.email}</span>
                            <button 
                                onClick={() => auth.signOut()}
                                className="bg-blue-700 px-4 py-2 rounded text-sm hover:bg-blue-800 whitespace-nowrap"
                            >
                                Esci
                            </button>
                        </div>
                    </div>

                    {reminderScaduti > 0 && view !== 'reminder' && (
                        <div className="bg-red-500 text-white p-3 text-center cursor-pointer hover:bg-red-600"
                             onClick={() => setView('reminder')}>
                            ‚ö†Ô∏è Hai {reminderScaduti} reminder scaduti! Clicca per visualizzarli
                        </div>
                    )}

                    <div className="max-w-4xl mx-auto p-4">
                        {view === 'spese' && (
                            <SpeseView 
                                spese={spese}
                                categorie={categorie}
                                filtroCategoria={filtroCategoria}
                                setFiltroCategoria={setFiltroCategoria}
                                showAddSpesa={showAddSpesa}
                                setShowAddSpesa={setShowAddSpesa}
                                showGrafico={showGrafico}
                                setShowGrafico={setShowGrafico}
                                editingSpesa={editingSpesa}
                                setEditingSpesa={setEditingSpesa}
                            />
                        )}
                        
                        {view === 'categorie' && (
                            <CategorieView 
                                categorie={categorie}
                                showAddCategoria={showAddCategoria}
                                setShowAddCategoria={setShowAddCategoria}
                                editingCategoria={editingCategoria}
                                setEditingCategoria={setEditingCategoria}
                            />
                        )}
                        
                        {view === 'reminder' && (
                            <ReminderView 
                                reminders={reminders}
                                showAddReminder={showAddReminder}
                                setShowAddReminder={setShowAddReminder}
                                editingReminder={editingReminder}
                                setEditingReminder={setEditingReminder}
                            />
                        )}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
                        <div className="flex justify-around items-center p-2">
                            <button 
                                onClick={() => setView('spese')}
                                className={`flex flex-col items-center p-2 rounded flex-1 ${view === 'spese' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'}`}
                            >
                                <span className="text-2xl">üí≥</span>
                                <span className="text-xs mt-1">Spese</span>
                            </button>
                            
                            <button 
                                onClick={() => setView('categorie')}
                                className={`flex flex-col items-center p-2 rounded flex-1 ${view === 'categorie' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'}`}
                            >
                                <span className="text-2xl">üìÅ</span>
                                <span className="text-xs mt-1">Categorie</span>
                            </button>
                            
                            <button 
                                onClick={() => setView('reminder')}
                                className={`flex flex-col items-center p-2 rounded flex-1 relative ${view === 'reminder' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'}`}
                            >
                                <span className="text-2xl">üîî</span>
                                <span className="text-xs mt-1">Reminder</span>
                                {reminderScaduti > 0 && (
                                    <span className="absolute top-0 right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center badge">
                                        {reminderScaduti}
                                    </span>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function LoginPage() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4">üí∞</div>
                            <h1 className="text-3xl font-bold text-gray-800">Tracker Spese</h1>
                            <p className="text-gray-600 mt-2">Gestisci le spese di famiglia</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                    minLength="6"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading ? 'Caricamento...' : (isLogin ? 'Accedi' : 'Registrati')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-blue-600 hover:underline text-sm"
                            >
                                {isLogin ? 'Non hai un account? Registrati' : 'Hai gi√† un account? Accedi'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function SpeseView({ spese, categorie, filtroCategoria, setFiltroCategoria, showAddSpesa, setShowAddSpesa, showGrafico, setShowGrafico, editingSpesa, setEditingSpesa }) {
            const speseFiltrate = filtroCategoria === 'tutte' 
                ? spese 
                : spese.filter(s => s.categoria === filtroCategoria);

            const totale = speseFiltrate.reduce((acc, spesa) => acc + parseFloat(spesa.importo), 0);

            const oggi = new Date();
            const meseCorrente = oggi.getMonth();
            const annoCorrente = oggi.getFullYear();
            
            const speseQuestoMese = spese.filter(s => {
                const dataSpesa = new Date(s.data);
                return dataSpesa.getMonth() === meseCorrente && dataSpesa.getFullYear() === annoCorrente;
            });
            
            const speseMeseScorso = spese.filter(s => {
                const dataSpesa = new Date(s.data);
                const meseScorso = meseCorrente === 0 ? 11 : meseCorrente - 1;
                const annoMeseScorso = meseCorrente === 0 ? annoCorrente - 1 : annoCorrente;
                return dataSpesa.getMonth() === meseScorso && dataSpesa.getFullYear() === annoMeseScorso;
            });
            
            const totaleQuestoMese = speseQuestoMese.reduce((acc, s) => acc + parseFloat(s.importo), 0);
            const totaleMeseScorso = speseMeseScorso.reduce((acc, s) => acc + parseFloat(s.importo), 0);
            const differenza = totaleQuestoMese - totaleMeseScorso;
            const percentuale = totaleMeseScorso > 0 ? ((differenza / totaleMeseScorso) * 100).toFixed(1) : 0;

            const eliminaSpesa = async (id) => {
                if (confirm('Vuoi eliminare questa spesa?')) {
                    await db.collection('spese').doc(id).delete();
                }
            };

            return (
                <div className="fade-in">
                    <div className="mb-4 flex gap-2 overflow-x-auto pb-2">
                        <button
                            onClick={() => setFiltroCategoria('tutte')}
                            className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium ${filtroCategoria === 'tutte' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                            Tutte
                        </button>
                        {categorie.map(cat => (
                            <button
                                key={cat.id}
                                onClick={() => setFiltroCategoria(cat.nome)}
                                className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium ${filtroCategoria === cat.nome ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                            >
                                {cat.nome}
                            </button>
                        ))}
                    </div>

                    <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-4 mb-4 shadow-lg">
                        <div className="mb-3">
                            <p className="text-xs opacity-90 mb-1">
                                {filtroCategoria !== 'tutte' ? filtroCategoria : 'Totale generale'}
                            </p>
                            <p className="text-3xl font-bold">‚Ç¨ {totale.toFixed(2)}</p>
                            <p className="text-xs opacity-75 mt-1">{speseFiltrate.length} spese</p>
                        </div>
                        
                        {filtroCategoria === 'tutte' && (
                            <>
                                <div className="border-t border-blue-500 pt-3 mt-3">
                                    <div className="flex justify-between items-start text-xs mb-2">
                                        <div className="flex-1">
                                            <p className="opacity-75 mb-1">Questo mese</p>
                                            <p className="text-lg font-bold">‚Ç¨ {totaleQuestoMese.toFixed(2)}</p>
                                            <p className="opacity-75">{speseQuestoMese.length} spese</p>
                                        </div>
                                        <div className="flex-1 text-right">
                                            <p className="opacity-75 mb-1">Mese scorso</p>
                                            <p className="text-lg font-bold">‚Ç¨ {totaleMeseScorso.toFixed(2)}</p>
                                            <p className="opacity-75">{speseMeseScorso.length} spese</p>
                                        </div>
                                    </div>
                                    {totaleMeseScorso > 0 && (
                                        <div className={`text-center py-2 px-3 rounded ${differenza > 0 ? 'bg-red-500' : 'bg-green-500'} bg-opacity-30 mb-2`}>
                                            <span className="font-bold">
                                                {differenza > 0 ? '‚Üë' : '‚Üì'} {Math.abs(percentuale)}%
                                            </span>
                                            <span className="text-xs ml-2">
                                                {differenza > 0 ? 'speso di pi√π' : 'risparmiato'} (‚Ç¨ {Math.abs(differenza).toFixed(2)})
                                            </span>
                                        </div>
                                    )}
                                </div>
                                <button
                                    onClick={() => setShowGrafico(true)}
                                    className="w-full bg-white bg-opacity-20 hover:bg-opacity-30 py-2 px-4 rounded text-sm font-medium mt-2"
                                >
                                    üìä Mostra Andamento
                                </button>
                            </>
                        )}
                    </div>

                    <button
                        onClick={() => setShowAddSpesa(true)}
                        className="w-full bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600 mb-4 shadow"
                    >
                        ‚ûï Aggiungi Spesa
                    </button>

                    <div className="space-y-3">
                        {speseFiltrate.length === 0 ? (
                            <div className="text-center py-12 text-gray-400">
                                <p className="text-4xl mb-2">üì≠</p>
                                <p>Nessuna spesa registrata</p>
                            </div>
                        ) : (
                            speseFiltrate.map(spesa => {
                                return (
                                    <div key={spesa.id} className="bg-white rounded-lg p-4 shadow">
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex-1">
                                                <p className="font-bold text-lg text-gray-800">{spesa.descrizione}</p>
                                                <p className="text-sm text-gray-500">{spesa.categoria}</p>
                                            </div>
                                            <div className="flex gap-1 ml-2">
                                                <button
                                                    onClick={() => setEditingSpesa(spesa)}
                                                    className="text-blue-500 hover:text-blue-700 p-1"
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                                <button
                                                    onClick={() => eliminaSpesa(spesa.id)}
                                                    className="text-red-500 hover:text-red-700 p-1"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-end">
                                            <div className="text-xs text-gray-400">
                                                {new Date(spesa.data).toLocaleDateString('it-IT')}
                                                {spesa.nota && <p className="mt-1 text-gray-500">{spesa.nota}</p>}
                                            </div>
                                            <p className="text-2xl font-bold text-blue-600">‚Ç¨ {parseFloat(spesa.importo).toFixed(2)}</p>
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {showAddSpesa && (
                        <AddSpesaModal 
                            onClose={() => setShowAddSpesa(false)}
                            categorie={categorie}
                        />
                    )}

                    {editingSpesa && (
                        <EditSpesaModal 
                            spesa={editingSpesa}
                            onClose={() => setEditingSpesa(null)}
                            categorie={categorie}
                        />
                    )}

                    {showGrafico && (
                        <GraficoAndamentoModal 
                            spese={spese}
                            onClose={() => setShowGrafico(false)}
                        />
                    )}
                </div>
            );
        }

        function AddSpesaModal({ onClose, categorie }) {
            const [descrizione, setDescrizione] = useState('');
            const [importo, setImporto] = useState('');
            const [categoria, setCategoria] = useState('');
            const [data, setData] = useState(new Date().toISOString().split('T')[0]);
            const [nota, setNota] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await db.collection('spese').add({
                        descrizione,
                        importo: parseFloat(importo),
                        categoria,
                        data,
                        nota,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: auth.currentUser.uid
                    });
                    onClose();
                } catch (err) {
                    alert('Errore: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Nuova Spesa</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Descrizione *</label>
                                <input
                                    type="text"
                                    value={descrizione}
                                    onChange={(e) => setDescrizione(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                    placeholder="Es: Spesa supermercato"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Importo (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={importo}
                                    onChange={(e) => setImporto(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                    placeholder="0.00"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                                <select
                                    value={categoria}
                                    onChange={(e) => setCategoria(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                >
                                    <option value="">Seleziona categoria</option>
                                    {categorie.map(cat => (
                                        <option key={cat.id} value={cat.nome}>
                                            {cat.nome}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Data *</label>
                                <input
                                    type="date"
                                    value={data}
                                    onChange={(e) => setData(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nota (opzionale)</label>
                                <textarea
                                    value={nota}
                                    onChange={(e) => setNota(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    rows="2"
                                    placeholder="Note aggiuntive..."
                                />
                            </div>

                            <div className="flex gap-2 pt-2">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
                                >
                                    {loading ? 'Salvataggio...' : 'Aggiungi'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditSpesaModal({ spesa, onClose, categorie }) {
            const [descrizione, setDescrizione] = useState(spesa.descrizione);
            const [importo, setImporto] = useState(spesa.importo);
            const [categoria, setCategoria] = useState(spesa.categoria);
            const [data, setData] = useState(spesa.data);
            const [nota, setNota] = useState(spesa.nota || '');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await db.collection('spese').doc(spesa.id).update({
                        descrizione,
                        importo: parseFloat(importo),
                        categoria,
                        data,
                        nota,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    onClose();
                } catch (err) {
                    alert('Errore: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Modifica Spesa</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Descrizione *</label>
                                <input
                                    type="text"
                                    value={descrizione}
                                    onChange={(e) => setDescrizione(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Importo (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={importo}
                                    onChange={(e) => setImporto(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                                <select
                                    value={categoria}
                                    onChange={(e) => setCategoria(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                >
                                    {categorie.map(cat => (
                                        <option key={cat.id} value={cat.nome}>
                                            {cat.nome}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Data *</label>
                                <input
                                    type="date"
                                    value={data}
                                    onChange={(e) => setData(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nota (opzionale)</label>
                                <textarea
                                    value={nota}
                                    onChange={(e) => setNota(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    rows="2"
                                />
                            </div>

                            <div className="flex gap-2 pt-2">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
                                >
                                    {loading ? 'Salvataggio...' : 'Salva Modifiche'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function GraficoAndamentoModal({ spese, onClose }) {
            const canvasRef = React.useRef(null);
            const chartRef = React.useRef(null);

            React.useEffect(() => {
                if (!canvasRef.current) return;

                const oggi = new Date();
                const datiMesi = [];
                
                for (let i = 5; i >= 0; i--) {
                    const mese = new Date(oggi.getFullYear(), oggi.getMonth() - i, 1);
                    const meseProssimo = new Date(oggi.getFullYear(), oggi.getMonth() - i + 1, 1);
                    
                    const speseDelMese = spese.filter(s => {
                        const dataSpesa = new Date(s.data);
                        return dataSpesa >= mese && dataSpesa < meseProssimo;
                    });
                    
                    const totale = speseDelMese.reduce((acc, s) => acc + parseFloat(s.importo), 0);
                    
                    datiMesi.push({
                        mese: mese.toLocaleDateString('it-IT', { month: 'short', year: '2-digit' }),
                        totale: totale,
                        numSpese: speseDelMese.length
                    });
                }

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: datiMesi.map(d => d.mese),
                        datasets: [{
                            label: 'Spese Mensili (‚Ç¨)',
                            data: datiMesi.map(d => d.totale),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        return [
                                            `Totale: ‚Ç¨ ${context.parsed.y.toFixed(2)}`,
                                            `Spese: ${datiMesi[index].numSpese}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç¨ ' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [spese]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center rounded-t-2xl">
                            <h2 className="text-xl font-bold">üìä Andamento Spese</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <div className="p-4">
                            <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                <p className="text-sm text-gray-600 mb-2">Ultimi 6 mesi</p>
                                <div style={{ height: '300px' }}>
                                    <canvas ref={canvasRef}></canvas>
                                </div>
                            </div>

                            <button
                                onClick={onClose}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"
                            >
                                Chiudi
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function CategorieView({ categorie, showAddCategoria, setShowAddCategoria, editingCategoria, setEditingCategoria }) {
            const eliminaCategoria = async (id) => {
                if (confirm('Vuoi eliminare questa categoria? Le spese associate rimarranno ma dovrai riassegnarle.')) {
                    await db.collection('categorie').doc(id).delete();
                }
            };

            return (
                <div className="fade-in">
                    <div className="mb-4">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Le tue Categorie</h2>
                        <p className="text-gray-600 text-sm">Gestisci le categorie per organizzare le spese</p>
                    </div>

                    <button
                        onClick={() => setShowAddCategoria(true)}
                        className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 mb-4 shadow"
                    >
                        ‚ûï Nuova Categoria
                    </button>

                    <div className="space-y-3">
                        {categorie.length === 0 ? (
                            <div className="text-center py-12 text-gray-400">
                                <p className="text-4xl mb-2">üìÅ</p>
                                <p>Nessuna categoria creata</p>
                                <p className="text-sm mt-2">Crea la prima categoria per iniziare</p>
                            </div>
                        ) : (
                            categorie.map(cat => (
                                <div key={cat.id} className="bg-white rounded-lg p-4 shadow flex justify-between items-center">
                                    <div>
                                        <p className="font-bold text-lg text-gray-800">{cat.nome}</p>
                                        {cat.descrizione && <p className="text-sm text-gray-500 mt-1">{cat.descrizione}</p>}
                                    </div>
                                    <div className="flex gap-1">
                                        <button
                                            onClick={() => setEditingCategoria(cat)}
                                            className="text-blue-500 hover:text-blue-700 p-2"
                                        >
                                            ‚úèÔ∏è
                                        </button>
                                        <button
                                            onClick={() => eliminaCategoria(cat.id)}
                                            className="text-red-500 hover:text-red-700 p-2"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {showAddCategoria && (
                        <AddCategoriaModal onClose={() => setShowAddCategoria(false)} />
                    )}

                    {editingCategoria && (
                        <EditCategoriaModal 
                            categoria={editingCategoria}
                            onClose={() => setEditingCategoria(null)}
                        />
                    )}
                </div>
            );
        }

        function AddCategoriaModal({ onClose }) {
            const [nome, setNome] = useState('');
            const [descrizione, setDescrizione] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await db.collection('categorie').add({
                        nome,
                        icona: 'üìÅ',
                        descrizione,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    onClose();
                } catch (err) {
                    alert('Errore: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Nuova Categoria</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                                <input
                                    type="text"
                                    value={nome}
                                    onChange={(e) => setNome(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                    placeholder="Es: Alimentari, Trasporti, Casa..."
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Descrizione (opzionale)</label>
                                <input
                                    type="text"
                                    value={descrizione}
                                    onChange={(e) => setDescrizione(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Es: Spese per cibo e bevande"
                                />
                            </div>

                            <div className="flex gap-2 pt-2">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
                                >
                                    {loading ? 'Salvataggio...' : 'Crea'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditCategoriaModal({ categoria, onClose }) {
            const [nome, setNome] = useState(categoria.nome);
            const [descrizione, setDescrizione] = useState(categoria.descrizione || '');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await db.collection('categorie').doc(categoria.id).update({
                        nome,
                        descrizione,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    onClose();
                } catch (err) {
                    alert('Errore: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Modifica Categoria</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                                <input
                                    type="text"
                                    value={nome}
                                    onChange={(e) => setNome(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Descrizione (opzionale)</label>
                                <input
                                    type="text"
                                    value={descrizione}
                                    onChange={(e) => setDescrizione(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div className="flex gap-2 pt-2">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
                                >
                                    {loading ? 'Salvataggio...' : 'Salva Modifiche'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ReminderView({ reminders, showAddReminder, setShowAddReminder, editingReminder, setEditingReminder }) {
            const oggi = new Date().toISOString().split('T')[0];
            
            const toggleCompletato = async (id, completato) => {
                await db.collection('reminders').doc(id).update({
                    completato: !completato
                });
            };

            const eliminaReminder = async (id) => {
                if (confirm('Vuoi eliminare questo reminder?')) {
                    await db.collection('reminders').doc(id).delete();
                }
            };

            const reminderAttivi = reminders.filter(r => !r.completato);
            const reminderCompletati = reminders.filter(r => r.completato);

            return (
                <div className="fade-in">
                    <div className="mb-4">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">I tuoi Reminder</h2>
                        <p className="text-gray-600 text-sm">Gestisci promemoria e scadenze</p>
                    </div>

                    <button
                        onClick={() => setShowAddReminder(true)}
                        className="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 mb-4 shadow"
                    >
                        ‚ûï Nuovo Reminder
                    </button>

                    <div className="mb-6">
                        <h3 className="font-bold text-gray-700 mb-3">Da Fare ({reminderAttivi.length})</h3>
                        <div className="space-y-3">
                            {reminderAttivi.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <p className="text-3xl mb-2">‚úÖ</p>
                                    <p>Nessun reminder attivo</p>
                                </div>
                            ) : (
                                reminderAttivi.map(reminder => {
                                    const isScaduto = reminder.dataScadenza < oggi;
                                    return (
                                        <div key={reminder.id} className={`bg-white rounded-lg p-4 shadow border-l-4 ${isScaduto ? 'border-red-500' : 'border-blue-500'}`}>
                                            <div className="flex items-start gap-3">
                                                <button
                                                    onClick={() => toggleCompletato(reminder.id, reminder.completato)}
                                                    className="mt-1 w-6 h-6 rounded border-2 border-gray-300 hover:border-blue-600 flex-shrink-0"
                                                />
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-medium text-gray-800">{reminder.titolo}</p>
                                                    {reminder.descrizione && (
                                                        <p className="text-sm text-gray-600 mt-1">{reminder.descrizione}</p>
                                                    )}
                                                    <div className="flex flex-wrap items-center gap-2 mt-2">
                                                        <span className={`text-xs px-2 py-1 rounded ${isScaduto ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                                                            {isScaduto ? '‚ö†Ô∏è Scaduto' : 'üìÖ'} {new Date(reminder.dataScadenza).toLocaleDateString('it-IT')}
                                                        </span>
                                                        {reminder.importoStimato && (
                                                            <span className="text-xs px-2 py-1 rounded bg-green-100 text-green-700">
                                                                üí∞ ‚Ç¨ {reminder.importoStimato}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex gap-1 flex-shrink-0">
                                                    <button
                                                        onClick={() => setEditingReminder(reminder)}
                                                        className="text-blue-500 hover:text-blue-700 p-1"
                                                    >
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button
                                                        onClick={() => eliminaReminder(reminder.id)}
                                                        className="text-red-500 hover:text-red-700 p-1"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>

                    {reminderCompletati.length > 0 && (
                        <div>
                            <h3 className="font-bold text-gray-700 mb-3">Completati ({reminderCompletati.length})</h3>
                            <div className="space-y-3">
                                {reminderCompletati.map(reminder => (
                                    <div key={reminder.id} className="bg-gray-50 rounded-lg p-4 shadow opacity-75">
                                        <div className="flex items-start gap-3">
                                            <button
                                                onClick={() => toggleCompletato(reminder.id, reminder.completato)}
                                                className="mt-1 w-6 h-6 rounded border-2 border-green-500 bg-green-500 text-white flex items-center justify-center flex-shrink-0"
                                            >
                                                ‚úì
                                            </button>
                                            <div className="flex-1">
                                                <p className="font-medium text-gray-600 line-through">{reminder.titolo}</p>
                                                {reminder.descrizione && (
                                                    <p className="text-sm text-gray-500 mt-1">{reminder.descrizione}</p>
                                                )}
                                            </div>
                                            <button
                                                onClick={() => eliminaReminder(reminder.id)}
                                                className="text-red-500 hover:text-red-700 p-1"
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {showAddReminder && (
                        <AddReminderModal onClose={() => setShowAddReminder(false)} />
                    )}

                    {editingReminder && (
                        <EditReminderModal 
                            reminder={editingReminder}
                            onClose={() => setEditingReminder(null)}
                        />
                    )}
                </div>
            );
        }

        function AddReminderModal({ onClose }) {
            const [titolo, setTitolo] = useState('');
            const [descrizione, setDescrizione] = useState('');
            const [dataScadenza, setDataScadenza] = useState('');
            const [importoStimato, setImportoStimato] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await db.collection('reminders').add({
                        titolo,
                        descrizione,
                        dataScadenza,
                        importoStimato: importoStimato ? parseFloat(importoStimato) : null,
                        completato: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    onClose();
                } catch (err) {
                    alert('Errore: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Nuovo Reminder</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Titolo *</label>
                                <input
                                    type="text"
                                    value={titolo}
                                    onChange={(e) => setTitolo(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                    placeholder="Es: Pagare bolletta luce"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Descrizione (opzionale)</label>
                                <textarea
                                    value={descrizione}
                                    onChange={(e) => setDescrizione(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    rows="2"
                                    placeholder="Note aggiuntive..."
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Data Scadenza *</label>
                                <input
                                    type="date"
                                    value={dataScadenza}
                                    onChange={(e) => setDataScadenza(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Importo Stimato (‚Ç¨) - Opzionale</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={importoStimato}
                                    onChange={(e) => setImportoStimato(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="0.00"
                                />
                            </div>

                            <div className="flex gap-2 pt-2">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 disabled:opacity-50"
                                >
                                    {loading ? 'Salvataggio...' : 'Crea'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditReminderModal({ reminder, onClose }) {
            const [titolo, setTitolo] = useState(reminder.titolo);
            const [descrizione, setDescrizione] = useState(reminder.descrizione || '');
            const [dataScadenza, setDataScadenza] = useState(reminder.dataScadenza);
            const [importoStimato, setImportoStimato] = useState(reminder.importoStimato || '');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    await db.collection('reminders').doc(reminder.id).update({
                        titolo,
                        descrizione,
                        dataScadenza,
                        importoStimato: importoStimato ? parseFloat(importoStimato) : null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    onClose();
                } catch (err) {
                    alert('Errore: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg">
                        <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Modifica Reminder</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Titolo *</label>
                                <input
                                    type="text"
                                    value={titolo}
                                    onChange={(e) => setTitolo(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Descrizione (opzionale)</label>
                                <textarea
                                    value={descrizione}
                                    onChange={(e) => setDescrizione(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    rows="2"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Data Scadenza *</label>
                                <input
                                    type="date"
                                    value={dataScadenza}
                                    onChange={(e) => setDataScadenza(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Importo Stimato (‚Ç¨) - Opzionale</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={importoStimato}
                                    onChange={(e) => setImportoStimato(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div className="flex gap-2 pt-2">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 disabled:opacity-50"
                                >
                                    {loading ? 'Salvataggio...' : 'Salva Modifiche'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
